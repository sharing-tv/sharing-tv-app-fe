
<!-- src/app/admin/palinsesto/palinsesto.component.html -->

<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Gestione Palinsesto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <ion-refresher slot="fixed" (ionRefresh)="loadData(); $event.target.complete()">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- LOADING -->
  <ng-container *ngIf="loading">
    <div class="center">
      <ion-spinner></ion-spinner>
    </div>
  </ng-container>

  <!-- ERROR -->
  <ion-text color="danger" *ngIf="error">
    <p>{{ error }}</p>
  </ion-text>

  <!-- MAIN CONTENT -->
  <ng-container *ngIf="!loading && !error">

    <!-- Sync VOD -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Gestione contenuti VOD</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-button expand="block" color="secondary" (click)="syncVod()">
          üîÑ Aggiorna lista VOD
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Impostazioni Canale -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Impostazioni Canale</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none">
          <ion-label>Loop infinito</ion-label>
          <ion-toggle [(ngModel)]="loop"></ion-toggle>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Timeline -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Timeline (EPG)</ion-card-title>
      </ion-card-header>

      <!-- üîç ZOOM CONTROLS -->
      <div class="timeline-zoom-controls">
        <ion-button size="small" (click)="setZoom(6)">6h</ion-button>
        <ion-button size="small" (click)="setZoom(12)">12h</ion-button>
        <ion-button size="small" (click)="setZoom(16)">16h</ion-button>
        <ion-button size="small" (click)="setZoom(24)">24h</ion-button>
      </div>

      <ion-card-content>
        <div class="timeline-wrapper">
          <!-- TRACK LARGA 24H (1440 minuti * zoomFactor px) -->
          <div class="timeline-track" [style.width.px]="1440 * zoomFactor">

            <!-- Ore -->
            <div
              class="timeline-hour"
              *ngFor="let h of [].constructor(24); let i = index"
              [style.left.px]="i * 60 * zoomFactor">
              {{ i }}:00
            </div>

            <!-- Eventi + spazi liberi -->
            <div class="timeline-items">
              <div class="tl-item"
                *ngFor="let t of timeline; let i = index"
                [style.width.px]="t.width * zoomFactor"
                [style.left.px]="t.offset * zoomFactor"
                [ngClass]="{ 'free': t.free, 'conflict': t.conflict }">

                <!-- Tooltip -->
                <div class="tooltip">
                  <!-- EVENTO -->
                  <ng-container *ngIf="!t.free">
                    <strong>{{ t.title }}</strong><br>
                    {{ formatHHMMSS(t.start) }} ‚Üí {{ formatHHMMSS(t.end) }}<br>
                    Durata: {{ formatDuration(t.end - t.start) }}
                    <span *ngIf="t.conflict"><br>‚ö† Conflitto orario</span>
                  </ng-container>

                  <!-- SPAZIO LIBERO -->
                  <ng-container *ngIf="t.free">
                    üïì <strong>Spazio libero</strong><br>
                    Durata: {{ formatDuration(t.end - t.start) }}
                  </ng-container>
                </div>

                <!-- CONTENUTO VISIVO BREVETTE -->
                <ng-container *ngIf="t.free; else eventBlock">
                  <strong>üïì Spazio libero</strong><br>
                  Durata: {{ formatDuration(t.end - t.start) }}
                </ng-container>

                <ng-template #eventBlock>
                  <strong>{{ t.title }}</strong><br>
                  {{ formatHHMMSS(t.start) }} ‚Üí {{ formatHHMMSS(t.end) }}
                </ng-template>

              </div>
            </div>
          </div>
        </div>
      </ion-card-content>

      <!-- BADGE UTC -->
      <div class="utc-badge">
        ‚ö†Ô∏è Ricorda: il palinsesto usa orario <strong>UTC</strong>.<br>
        Ora UTC attuale: <strong>{{ utcNow }}</strong><br>
        La messa in onda utilizza invece il tuo orario locale.
      </div>

    </ion-card>

    <!-- COLONNE -->
    <div class="columns">

      <!-- VOD disponibili -->
      <div class="col">
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              VOD disponibili ({{ filteredVods.length }}/{{ vodList.length }})
            </ion-card-title>
          </ion-card-header>

          <ion-card-content>

            <!-- Ricerca + ordinamento -->
            <ion-item>
              <ion-input
                placeholder="Cerca per nome..."
                [(ngModel)]="vodSearch">
              </ion-input>

              <ion-select [(ngModel)]="vodSort" interface="popover">
                <ion-select-option value="name">Ordina per nome</ion-select-option>
                <ion-select-option value="date">Ordina per durata</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-list>
              <ion-item *ngFor="let v of filteredVods">
                <ion-label>
                  <h2>{{ v.title }}</h2>
                  <p>{{ v.bunnyId }} ‚Ä¢ Durata: {{ formatDuration(v.length!) }}</p>
                </ion-label>

                <ion-button fill="outline" size="small" (click)="addVod(v)">
                  Aggiungi
                </ion-button>
              </ion-item>
            </ion-list>

          </ion-card-content>
        </ion-card>
      </div>

      <!-- PALINSESTO -->
      <div class="col">

        <ion-card>
          <ion-card-header>
            <ion-card-title>Palinsesto (ordine di messa in onda)</ion-card-title>
          </ion-card-header>

          <!-- PULSANTE SALVA IN ALTO -->
          <div class="save-top">
            <ion-button expand="block" (click)="save()" [disabled]="saving">
              <ion-spinner *ngIf="saving" slot="start"></ion-spinner>
              Salva palinsesto
            </ion-button>
          </div>

          <ion-card-content>

            <ion-list *ngIf="items.length > 0; else noItems"
                      cdkDropList
                      (cdkDropListDropped)="drop($event)">

              <!-- Ordine invertito: ultimo aggiunto = 1 -->
              <ion-item *ngFor="let item of items.slice().reverse(); let i = index"
                        cdkDrag
                        class="palinsesto-item"
                        [class.conflict]="item.conflict">

                <div class="content-col">

                  <h2 class="title">{{ i + 1 }}. {{ item.title }}</h2>

                  <div class="info-grid">

                    <!-- INIZIO -->
                    <div class="info-box">
                      <label>Inizio</label>

                      <!-- VIEW -->
                      <div *ngIf="!item.editing">
                        <strong>{{ item.editDate }} {{ formatHHMMSS(item.startAt) }}</strong><br>

                        <ion-button size="small"
                                    fill="outline"
                                    (click)="item.editing = true">
                          Modifica
                        </ion-button>
                      </div>

                      <!-- EDIT -->
                      <div *ngIf="item.editing" class="edit-time-row">

                        <input type="date"
                               [(ngModel)]="item.editDate"
                               class="date-input" />

                        <select [(ngModel)]="item.editHour">
                          <option *ngFor="let h of hours" [value]="h">
                            {{ h | number:'2.0' }}
                          </option>
                        </select>

                        <select [(ngModel)]="item.editMinute">
                          <option *ngFor="let m of minutes" [value]="m">
                            {{ m | number:'2.0' }}
                          </option>
                        </select>

                        <select [(ngModel)]="item.editSecond">
                          <option *ngFor="let s of seconds" [value]="s">
                            {{ s | number:'2.0' }}
                          </option>
                        </select>

                        <ion-button size="small"
                                    color="success"
                                    fill="outline"
                                    (click)="saveStartTime(item)">
                          Salva
                        </ion-button>
                      </div>
                    </div>

                    <!-- FINE -->
                    <div class="info-box">
                      <label>Fine</label>
                      <p>{{ formatHHMMSS(item.endAt) }}</p>
                    </div>

                    <!-- DURATA -->
                    <div class="info-box">
                      <label>Durata</label>
                      <p>{{ formatDuration(item.length) }}</p>
                    </div>

                    <!-- BUNNY -->
                    <!-- <div class="info-box">
                      <label>BunnyID</label>
                      <p>{{ item.bunnyId }}</p>
                    </div> -->
                  </div>

                  <p *ngIf="item.conflict" class="conflict-msg">
                    ‚ö† Sovrapposizione oraria!
                  </p>

                </div>

                <div class="buttons-col">
                  <ion-button fill="clear" size="small" (click)="moveUp(i)">‚Üë</ion-button>
                  <ion-button fill="clear" size="small" (click)="moveDown(i)">‚Üì</ion-button>
                  <ion-button size="small"
                              color="danger"
                              fill="outline"
                              (click)="removeItem(item)">
                    Rimuovi
                  </ion-button>
                </div>

              </ion-item>

            </ion-list>

            <ng-template #noItems>
              <ion-text color="medium">
                <p>Nessun contenuto.</p>
              </ion-text>
            </ng-template>

          </ion-card-content>
        </ion-card>

      </div>
    </div>
  </ng-container>

</ion-content>

